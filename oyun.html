<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pong - Final Fix</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --gold: #D4AF37; --bordo: #9B1B30; --glass: rgba(255,255,255,0.1); }
        
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: radial-gradient(circle at center, #2b1a1a 0%, #0a0505 100%);
            color: #fff; font-family: 'Montserrat', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- MEN√ú TASARIMI --- */
        #menuContainer {
            width: 90%; max-width: 400px;
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 50;
            transition: opacity 0.5s;
        }

        h1 {
            margin: 0 0 20px 0;
            background: linear-gradient(to right, var(--gold), var(--bordo));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 900; letter-spacing: 2px; text-transform: uppercase;
        }

        input {
            width: 100%; padding: 15px; margin-bottom: 15px;
            background: rgba(0,0,0,0.3); border: none; border-bottom: 2px solid var(--gold);
            color: #fff; font-size: 1.1rem; text-align: center; font-weight: bold;
            outline: none; border-radius: 4px;
        }

        button {
            width: 100%; padding: 15px; margin-bottom: 10px;
            background: var(--gold); color: #000; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 900; cursor: pointer;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }
        button.secondary { background: transparent; border: 2px solid var(--gold); color: var(--gold); }
        button.start-game { background: #28a745; color: white; box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3); animation: pulseBtn 1s infinite; }

        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- OYUN ALANI (CANVAS) --- */
        #gameLayer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 100;
            display: none; /* JS ile flex yapƒ±lacak */
            align-items: center; justify-content: center;
        }

        canvas {
            max-width: 100%; max-height: 100%;
            background: rgba(20,10,10,0.9);
            box-shadow: 0 0 30px var(--bordo);
        }

        /* --- OYUN ARAY√úZ√ú (HUD) --- */
        #hudLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 101; display: none;
        }

        #timer {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            font-size: 2.5rem; font-weight: 900; color: rgba(255,255,255,0.8);
        }

        .p-names {
            position: absolute; top: 20px; width: 90%; left: 5%;
            display: flex; justify-content: space-between;
            font-weight: 700; font-size: 1.2rem; text-transform: uppercase;
        }

        #emojiBtn {
            position: absolute; bottom: 30px; right: 30px;
            width: 70px; height: 70px; background: rgba(155,27,48,0.3);
            border: 2px solid var(--bordo); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; pointer-events: auto; cursor: pointer;
        }

        /* --- MODAL (KAZANAN/HATA) --- */
        #modalOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        
        /* Utility */
        .hidden { display: none !important; }
        .text-gold { color: var(--gold); }
        .text-big { font-size: 3rem; margin: 10px 0; font-weight: 900; letter-spacing: 5px; }
        .status { margin-top: 10px; font-size: 0.8rem; color: #ccc; min-height: 20px; }
        
        /* Landscape Uyarƒ±sƒ± */
        #rotateMsg { display: none; position: fixed; z-index: 9999; background: #000; width: 100%; height: 100%; top:0; left:0; align-items: center; justify-content: center; flex-direction: column;}
        @media screen and (orientation: portrait) { #rotateMsg { display: flex; } }

    </style>
</head>
<body>

    <div id="rotateMsg">
        <div style="font-size:3rem; color:var(--gold);">‚Üª</div>
        <p style="color:white; margin-top:10px;">L√úTFEN TELEFONU YAN √áEVƒ∞R</p>
    </div>

    <div id="menuContainer">
        <h1>Couple Pong</h1>
        
        <div id="pName">
            <input type="text" id="inpName" placeholder="ƒ∞SMƒ∞Nƒ∞Z (Max 8)" maxlength="8">
            <button onclick="goModeSelect()">DEVAM ET</button>
        </div>

        <div id="pMode" class="hidden">
            <button onclick="startSingle()">ü§ñ ANTRENMAN</button>
            <button class="secondary" onclick="startHost()">üè† ODA KUR (HOST)</button>
            <button class="secondary" onclick="startJoin()">üîë ODAYA KATIL</button>
            <button class="secondary" style="margin-top:20px; font-size:0.8rem; border:none;" onclick="location.reload()">GERƒ∞</button>
        </div>

        <div id="pHost" class="hidden">
            <p>BU KODU ONA S√ñYLE:</p>
            <div id="displayCode" class="text-big text-gold">...</div>
            <div id="hostStatus" class="status">Sunucu ba≈ülatƒ±lƒ±yor...</div>
            
            <button id="btnStartGame" class="start-game hidden" onclick="hostTriggerStart()">OYUNU BA≈ûLAT ‚ñ∂</button>
            
            <button class="secondary" style="margin-top:20px;" onclick="location.reload()">ƒ∞PTAL</button>
        </div>

        <div id="pJoin" class="hidden">
            <p>4 HANELƒ∞ KODU Gƒ∞R:</p>
            <input type="number" id="inpCode" placeholder="1234" style="font-size:2rem; letter-spacing:5px;">
            <button onclick="joinSession()">BAƒûLAN</button>
            <div id="joinStatus" class="status"></div>
            <button class="secondary" style="margin-top:10px;" onclick="location.reload()">GERƒ∞</button>
        </div>
    </div>

    <div id="gameLayer">
        <canvas id="cvs" width="800" height="500"></canvas>
    </div>

    <div id="hudLayer">
        <div id="timer">00:00</div>
        <div class="p-names">
            <span id="lblP1" style="color:var(--gold)">P1</span>
            <span id="lblP2" style="color:var(--bordo)">P2</span>
        </div>
        <div id="emojiBtn" onclick="sendHeart()">‚ù§Ô∏è</div>
    </div>

    <div id="modalOverlay">
        <div style="font-size:80px; color:var(--gold);">‚ôõ</div>
        <p style="color:#aaa; letter-spacing:2px;">KAZANAN</p>
        <h2 id="winName" style="font-size:3rem; margin:10px 0; color:#fff;">-</h2>
        <button style="width:200px;" onclick="location.reload()">TEKRAR OYNA</button>
    </div>

<script>
    // --- AYARLAR ---
    const PEER_CONF = { config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478' } ] } };
    const G = { w: 800, h: 500 };
    
    // --- DURUM DEƒûƒ∞≈ûKENLERƒ∞ ---
    let state = {
        bx: 400, by: 250, bvx: 5, bvy: 5,
        p1: 200, p2: 200, s1: 0, s2: 0,
        time: 90, over: false
    };
    let role = null; // 'host', 'guest', 'single'
    let myName = "OYUNCU";
    let oppName = "RAKƒ∞P";
    let peer = null;
    let conn = null;
    let loopId = null;
    let timerId = null;
    let particles = [];
    let texts = [];

    // --- DOM ELEMANLARI ---
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');

    // --- Gƒ∞Rƒ∞≈û MANTIƒûI ---
    function goModeSelect() {
        const val = document.getElementById('inpName').value.trim();
        if(val) myName = val.toUpperCase();
        showPage('pMode');
        requestFullScreen();
    }

    function showPage(id) {
        ['pName','pMode','pHost','pJoin'].forEach(p => document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function requestFullScreen() {
        document.documentElement.requestFullscreen?.().catch(()=>{});
    }

    // --- SINGLE PLAYER ---
    function startSingle() {
        role = 'single'; oppName = "CPU";
        startGame();
    }

    // --- HOST LOGIC ---
    function startHost() {
        role = 'host';
        showPage('pHost');
        const code = Math.floor(Math.random()*9000)+1000;
        const id = "cpong-" + code;
        
        document.getElementById('displayCode').innerText = code;
        
        peer = new Peer(id, PEER_CONF);
        peer.on('open', () => { document.getElementById('hostStatus').innerText = "Oda a√ßƒ±ldƒ±, oyuncu bekleniyor..."; });
        peer.on('error', e => { 
            if(e.type==='unavailable-id') startHost(); // Kod √ßakƒ±≈üƒ±rsa yeniden dene
            else document.getElementById('hostStatus').innerText = "Hata: " + e.type; 
        });

        peer.on('connection', c => {
            conn = c;
            document.getElementById('hostStatus').innerText = "BAƒûLANDI! Ba≈ülat'a bas.";
            setupConnection();
        });
    }

    function hostTriggerStart() {
        if(conn && conn.open) {
            conn.send({ t: 'START_CMD' }); // Misafire ba≈ülat emri
            startGame(); // Kendin ba≈ülat
        }
    }

    // --- JOIN LOGIC ---
    function startJoin() { showPage('pJoin'); }

    function joinSession() {
        const code = document.getElementById('inpCode').value;
        if(code.length !== 4) return;
        
        role = 'guest';
        document.getElementById('joinStatus').innerText = "Sunucu aranƒ±yor...";
        
        peer = new Peer(null, PEER_CONF);
        peer.on('open', () => {
            conn = peer.connect("cpong-" + code);
            
            conn.on('open', () => {
                document.getElementById('joinStatus').innerText = "Baƒülandƒ±! Host'un ba≈ülatmasƒ± bekleniyor...";
                setupConnection();
            });
            
            setTimeout(() => {
                if(!conn || !conn.open) document.getElementById('joinStatus').innerText = "Oda bulunamadƒ±.";
            }, 5000);
        });
    }

    // --- ORTAK BAƒûLANTI AYARLARI ---
    function setupConnection() {
        // ƒ∞sim deƒüi≈ü toku≈üu
        conn.send({ t: 'NAME', n: myName });
        
        conn.on('data', d => {
            if(d.t === 'NAME') {
                oppName = d.n;
                if(role === 'host') {
                    // ƒ∞sim geldi, Host'a ba≈ülat butonunu g√∂ster
                    document.getElementById('hostStatus').innerText = oppName + " baƒülandƒ±!";
                    document.getElementById('btnStartGame').classList.remove('hidden');
                }
            }
            else if(d.t === 'START_CMD') { startGame(); } // Host ba≈ülattƒ±
            else if(d.t === 'MOVE') { 
                if(role === 'host') state.p2 = d.v; 
            }
            else if(d.t === 'SYNC') { // Host'tan gelen oyun verisi
                if(role === 'guest') {
                    state = d.s;
                    state.time = d.tm; // Zamanƒ± e≈üitle
                    updateTimeDisplay();
                }
            }
            else if(d.t === 'EMOJI') { spawnText(d.msg, false); }
            else if(d.t === 'OVER') { endGame(d.w); }
        });
    }

    // --- OYUN BA≈ûLATMA (KRƒ∞Tƒ∞K B√ñL√úM) ---
    function startGame() {
        // 1. Men√ºy√º yok et
        document.getElementById('menuContainer').style.display = 'none';
        
        // 2. Oyun katmanlarƒ±nƒ± a√ß
        const gl = document.getElementById('gameLayer');
        const hl = document.getElementById('hudLayer');
        gl.style.display = 'flex';
        hl.style.display = 'block';

        // 3. ƒ∞simleri yaz
        document.getElementById('lblP1').innerText = role==='guest' ? oppName : myName;
        document.getElementById('lblP2').innerText = role==='guest' ? myName : oppName;

        // 4. D√∂ng√ºleri Ba≈ülat
        if(role === 'host' || role === 'single') {
            timerId = setInterval(() => {
                state.time--;
                if(state.time <= 0) {
                    state.over = true;
                    finishGame();
                }
            }, 1000);
        }
        
        requestAnimationFrame(loop);
    }

    // --- OYUN D√ñNG√úS√ú ---
    function loop() {
        if(state.over) return;
        
        if(role === 'host' || role === 'single') updatePhysics();
        draw();
        
        if(role === 'host' && conn && conn.open) {
            // Misafire t√ºm durumu g√∂nder (Top, skorlar, zaman)
            conn.send({ t: 'SYNC', s: state, tm: state.time });
        }
        
        requestAnimationFrame(loop);
    }

    function updatePhysics() {
        state.bx += state.bvx; state.by += state.bvy;

        // CPU
        if(role === 'single') {
            let center = state.p2 + 50;
            if(center < state.by - 30) state.p2 += 6;
            else if(center > state.by + 30) state.p2 -= 6;
        }

        // Duvarlar
        if(state.by < 0 || state.by > G.h) state.bvy *= -1;

        // Raket √áarpƒ±≈üma
        // P1
        if(state.bx < 25 && state.by > state.p1 && state.by < state.p1 + 100) {
            state.bvx = Math.abs(state.bvx) * 1.05;
            spawnPart(state.bx, state.by, '#D4AF37');
        }
        else if(state.bx < 0) { state.s2++; resetBall(); }

        // P2
        if(state.bx > G.w - 25 && state.by > state.p2 && state.by < state.p2 + 100) {
            state.bvx = -Math.abs(state.bvx) * 1.05;
            spawnPart(state.bx, state.by, '#9B1B30');
        }
        else if(state.bx > G.w) { state.s1++; resetBall(); }

        // Sƒ±nƒ±rla
        state.p1 = Math.max(0, Math.min(400, state.p1));
        state.p2 = Math.max(0, Math.min(400, state.p2));
        
        updateTimeDisplay();
    }

    function resetBall() {
        state.bx = G.w/2; state.by = G.h/2;
        state.bvx = (Math.random()>0.5 ? 5 : -5);
        state.bvy = (Math.random()*6)-3;
    }

    // --- √áƒ∞Zƒ∞M ---
    function draw() {
        // Temizle
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,G.w,G.h);
        
        // Raketler
        ctx.shadowBlur = 20;
        ctx.fillStyle = '#D4AF37'; 
        ctx.shadowColor = '#D4AF37';
        ctx.fillRect(10, state.p1, 15, 100); // P1

        ctx.fillStyle = '#9B1B30'; 
        ctx.shadowColor = '#9B1B30';
        ctx.fillRect(G.w-25, state.p2, 15, 100); // P2

        // Top
        ctx.fillStyle = '#fff';
        ctx.shadowColor = '#fff';
        ctx.beginPath(); ctx.arc(state.bx, state.by, 8, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;

        // Efektler
        particles.forEach((p,i) => {
            p.x+=p.vx; p.y+=p.vy; p.l-=0.05;
            ctx.globalAlpha = p.l; ctx.fillStyle=p.c; 
            ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
            if(p.l<=0) particles.splice(i,1);
        });
        ctx.globalAlpha=1;

        texts.forEach((t,i) => {
            t.y--; t.l-=0.01;
            ctx.globalAlpha=t.l; ctx.font="20px Arial"; ctx.fillStyle="#fff"; ctx.textAlign="center";
            ctx.fillText(t.msg, t.x, t.y);
            if(t.l<=0) texts.splice(i,1);
        });
        ctx.globalAlpha=1;
    }

    // --- INPUT HANDLER ---
    window.addEventListener('touchmove', e => {
        if(document.getElementById('gameLayer').style.display === 'flex') {
            e.preventDefault();
            handleInput(e.touches[0].clientY);
        }
    }, {passive:false});

    window.addEventListener('mousemove', e => {
        if(document.getElementById('gameLayer').style.display === 'flex') {
            handleInput(e.clientY);
        }
    });

    function handleInput(y) {
        // Ekran koordinatƒ±nƒ± Canvas koordinatƒ±na √ßevir (Oranla)
        const rect = cvs.getBoundingClientRect();
        const scaleY = G.h / rect.height;
        const relativeY = (y - rect.top) * scaleY;
        
        const val = relativeY - 50; // Raket ortasƒ±

        if(role === 'host' || role === 'single') state.p1 = val;
        else if(conn && conn.open) conn.send({ t: 'MOVE', v: val });
    }

    // --- YARDIMCILAR ---
    function updateTimeDisplay() {
        let m = Math.floor(state.time/60);
        let s = Math.floor(state.time%60);
        document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
    }

    function spawnPart(x,y,c) {
        for(let i=0;i<10;i++) particles.push({x:x, y:y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, l:1, c:c});
    }

    function sendHeart() {
        spawnText("‚ù§Ô∏è SENƒ∞ SEVƒ∞YORUM", true);
        if(conn && conn.open) conn.send({t:'EMOJI', msg:"‚ù§Ô∏è SENƒ∞ SEVƒ∞YORUM"});
    }

    function spawnText(msg, isMine) {
        let x = isMine ? (role==='host'?150:650) : (role==='host'?650:150);
        texts.push({x:x, y:state.by, msg:msg, l:1.5});
    }

    function finishGame() {
        let w = state.s1 > state.s2 ? 'P1' : (state.s2 > state.s1 ? 'P2' : 'DRAW');
        if(conn && conn.open) conn.send({t:'OVER', w:w});
        endGame(w);
    }

    function endGame(winnerCode) {
        state.over = true;
        clearInterval(timerId);
        document.getElementById('modalOverlay').style.display = 'flex';
        
        let wName = "-";
        if(winnerCode === 'P1') wName = (role==='host'||role==='single') ? myName : oppName;
        else if(winnerCode === 'P2') wName = (role==='host'||role==='single') ? oppName : myName;
        else wName = "DOSTLUK";
        
        document.getElementById('winName').innerText = wName;
    }
</script>
</body>
</html>
